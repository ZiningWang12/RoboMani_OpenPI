# Pool Robot Simulation Docker Image
# å°çƒæœºæ¢°è‡‚ä»¿çœŸDockeré•œåƒ
FROM ubuntu:22.04

LABEL maintainer="OpenPI Team"
LABEL description="Pool Robot Simulation with OpenPI and Pooltool"
LABEL version="1.0.0"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV DISPLAY=:0
ENV QT_X11_NO_MITSHM=1
ENV MUJOCO_GL=egl

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3.10-venv \
    python3.10-dev \
    python-is-python3 \
    pip \
    curl \
    wget \
    git \
    build-essential \
    cmake \
    pkg-config \
    libegl1-mesa-dev \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    libglfw3-dev \
    libgles2-mesa-dev \
    xvfb \
    x11-apps \
    mesa-utils \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…UVåŒ…ç®¡ç†å™¨
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY requirements.txt requirements.in ./
COPY *.py ./
COPY README.md ./

# åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
RUN uv venv --python 3.10 .venv
RUN .venv/bin/pip install --upgrade pip
RUN .venv/bin/pip install -r requirements.txt

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p data/pooltool_results

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ğŸ± Starting Pool Robot Simulation Container"\n\
echo "========================================"\n\
\n\
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ\n\
source .venv/bin/activate\n\
\n\
# éªŒè¯ç¯å¢ƒ\n\
echo "Verifying environment..."\n\
python -c "import pooltool, pybullet; print(\"âœ… Environment verified\")" || {\n\
    echo "âŒ Environment verification failed"\n\
    exit 1\n\
}\n\
\n\
# è¿è¡Œä»¿çœŸ\n\
echo "Starting simulation with parameters: $@"\n\
python main.py "$@"\n\
' > /workspace/start.sh && chmod +x /workspace/start.sh

# è®¾ç½®å¯åŠ¨è„šæœ¬ä¸ºå…¥å£ç‚¹
ENTRYPOINT ["/workspace/start.sh"]

# é»˜è®¤å‚æ•°
CMD ["--task", "evaluation", "--trials", "3", "--no-gui"]

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python -c "import pooltool, pybullet; print('OK')" || exit 1

# æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦Webç•Œé¢ï¼‰
EXPOSE 8080

# è®¾ç½®å·æŒ‚è½½ç‚¹
VOLUME ["/workspace/data"] 